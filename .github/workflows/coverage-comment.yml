# Coverage Report Workflow
#
# This workflow generates test coverage reports for pull requests and posts a comparison
# comment showing the coverage differences between the PR branch and the base branch (main).
#
# The workflow runs in two stages:
# 1. coverage-main: Generates coverage report for the base branch (main)
# 2. coverage-pr: Generates coverage report for the PR branch and posts a comparison comment
#
# The comparison shows per-package coverage changes (lines, statements, functions, branches)
# to help reviewers understand the impact of changes on test coverage.

name: Coverage Report

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  TURBO_TELEMETRY_DISABLED: 1
  RUNNER_NODE_VERSION: 22
  RUNNER_PNPM_VERSION: 10.9.0
  COVERAGE_SUMMARY_FILE: coverage/coverage-summary.json
  BASE_COVERAGE_SUMMARY_FILE: coverage/base-coverage-summary.json

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  coverage-main:
    name: Generate Coverage Report (main)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.RUNNER_PNPM_VERSION }}
          run_install: false

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.RUNNER_NODE_VERSION }}
          cache: "pnpm"

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Install dependencies
        run: pnpm install
        shell: bash

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Build packages
        run: pnpm run build
        shell: bash

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Run tests with coverage
        run: pnpm run test
        shell: bash
        continue-on-error: true

      - name: Generate per-package coverage summary (main)
        run: node ./.github/scripts/generate-summary.mjs base-
        shell: bash

      - name: Upload coverage summary artifact (main)
        uses: actions/upload-artifact@v4
        with:
          name: base-coverage-summary
          path: coverage/base-coverage-summary.json

  coverage-pr:
    name: Generate Coverage Report (PR) and Comment
    runs-on: ubuntu-latest
    needs: coverage-main
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.RUNNER_PNPM_VERSION }}
          run_install: false

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.RUNNER_NODE_VERSION }}
          cache: "pnpm"

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Install dependencies
        run: pnpm install
        shell: bash

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Build packages
        run: pnpm run build
        shell: bash

      # NOTE: shared step; if editing make sure to review the other(s)
      - name: Run tests with coverage
        run: pnpm run test
        shell: bash
        continue-on-error: true

      - name: Generate per-package coverage summary (PR)
        run: node ./.github/scripts/generate-summary.mjs ""
        shell: bash

      - name: Download base coverage summary artifact
        uses: actions/download-artifact@v4
        with:
          name: base-coverage-summary
          path: coverage/

      - name: Install octokit
        run: pnpm add -w octokit

      - name: Comment PR with coverage results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: node .github/scripts/post-coverage-comment.mjs
