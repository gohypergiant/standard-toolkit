import { Meta } from '@storybook/addon-docs/blocks';

import * as EditShapeLayerStories from './edit-shape-layer.stories';

<Meta of={EditShapeLayerStories} />

# Edit Shape Layer

A deck.gl layer for interactively editing existing geographic shapes on a map. Integrates with `@deck.gl-community/editable-layers` to provide vertex-based polygon editing and resize-based circle editing.

## Features

- **Multiple geometry types**: Edit Point, LineString, Polygon, Rectangle, and Circle shapes
- **Smart mode selection**: Automatically selects the appropriate edit mode based on shape type
- **Protected editing mode**: Editing cannot be interrupted by other map mode requests
- **Visual reference**: Edit layer renders on top of display layer so users can see original position
- **Event bus integration**: Emits events via `@accelint/bus` for editing lifecycle
- **Multi-map support**: Events include map instance ID for isolation
- **Cursor integration**: Automatically changes cursor based on edit mode
- **ESC to cancel**: Press ESC key to cancel editing and restore original shape

## Edit Modes

The layer automatically selects the appropriate edit mode based on shape type:

| Shape Type | Edit Mode | Behavior |
|------------|-----------|----------|
| **Point** | `modify` | Drag to reposition |
| **LineString** | `modify` | Drag vertices to reshape |
| **Polygon** | `modify` | Drag vertices to reshape |
| **Rectangle** | `modify` | Drag corners to resize (locked to rectangle shape). Hold Shift to constrain to square. |
| **Circle** | `resize-circle` | Drag edge to resize from center |

## Dependencies

EditShapeLayer requires the following dependencies:

**Required:**
- [`@accelint/bus`](https://github.com/gohypergiant/standard-toolkit/tree/main/packages/bus) - Event bus for editing lifecycle events
- [`@accelint/core`](https://github.com/gohypergiant/standard-toolkit/tree/main/packages/core) - Core utilities including UUID generation
- [`@deck.gl/core`](https://deck.gl/) - Deck.gl core library for WebGL visualization
- [`@deck.gl-community/editable-layers`](https://github.com/visgl/deck.gl-community) - Editable geometry layers
- [`@deckgl-fiber-renderer/dom`](https://github.com/deckgl-fiber-renderer/fiber.gl) - React renderer for Deck.gl (for fiber usage)
- `react` - React 19.0.0 or higher

**Installation:**

```bash
npm install @accelint/map-toolkit @accelint/bus @accelint/core @deck.gl/core @deck.gl-community/editable-layers @deckgl-fiber-renderer/dom react
# or
pnpm add @accelint/map-toolkit @accelint/bus @accelint/core @deck.gl/core @deck.gl-community/editable-layers @deckgl-fiber-renderer/dom react
```

## Basic Usage

### With useEditShape Hook (Recommended)

The easiest way to use EditShapeLayer is with the `useEditShape` hook, which manages editing state and provides callbacks:

```tsx
import { BaseMap } from '@accelint/map-toolkit/deckgl/base-map';
import '@accelint/map-toolkit/deckgl/shapes/edit-shape-layer/fiber';
import '@accelint/map-toolkit/deckgl/shapes/display-shape-layer/fiber';
import {
  DisplayShapeLayer,
  EditShapeLayer,
  useEditShape,
  useShapeSelection,
} from '@accelint/map-toolkit/deckgl/shapes';
import { useMapCursor } from '@accelint/map-toolkit/map-cursor';
import { uuid } from '@accelint/core';
import { useState } from 'react';

const MAP_ID = uuid();

function MapWithEditing() {
  const [shapes, setShapes] = useState(initialShapes);

  // Required: subscribe to cursor store to enable cursor changes
  useMapCursor(MAP_ID);

  // Track selected shape
  const { selectedShape, select, deselect } = useShapeSelection();

  // Edit shape hook with callbacks
  const { edit, save, cancel, isEditing, editingShape } = useEditShape(MAP_ID, {
    onUpdate: (updatedShape) => {
      // Replace shape in state with updated geometry
      setShapes((prev) =>
        prev.map((s) => (s.id === updatedShape.id ? updatedShape : s))
      );
      deselect();
    },
    onCancel: (shape) => {
      console.log('Edit canceled for:', shape.name);
    },
  });

  const handleShapeClick = (shape) => {
    if (!isEditing) {
      select(shape);
    }
  };

  return (
    <div className="relative h-screen w-screen">
      <BaseMap id={MAP_ID}>
        {/* Display layer shows all shapes with selection styling */}
        <displayShapeLayer
          id="shapes"
          mapId={MAP_ID}
          data={shapes}
          showLabels
          pickable={!isEditing}
          selectedShapeId={selectedShape?.id ?? editingShape?.id}
          onShapeClick={handleShapeClick}
        />
        {/* Edit layer renders on top when editing */}
        <EditShapeLayer mapId={MAP_ID} />
      </BaseMap>

      {/* Edit controls */}
      <div className="absolute top-4 left-4">
        {selectedShape && !isEditing && (
          <button onClick={() => edit(selectedShape)}>
            Edit Shape
          </button>
        )}
        {isEditing && (
          <>
            <button onClick={save}>Save Changes</button>
            <button onClick={cancel}>Cancel</button>
          </>
        )}
      </div>
    </div>
  );
}
```

## Editing Instructions

### Polygon, LineString

1. Click on a shape to select it
2. Click "Edit" to enter edit mode
3. Drag vertices (white circles) to reshape
4. Click "Save" to confirm changes or "Cancel" (or press ESC) to discard

### Rectangle

1. Click on a rectangle to select it
2. Click "Edit" to enter edit mode
3. Drag corners to resize (shape remains a rectangle)
4. Hold **Shift** while dragging to constrain to a square
5. Click "Save" to confirm changes or "Cancel" (or press ESC) to discard

### Circle

1. Click on a circle to select it
2. Click "Edit" to enter edit mode
3. Drag the edge of the circle to resize (resizes from center)
4. Click "Save" to confirm changes or "Cancel" (or press ESC) to discard

### Keyboard Shortcuts

- **ESC**: Cancel current editing and restore original shape
- **Shift** (hold while dragging): Constrain rectangle to square

## Visual Reference

When editing, both the DisplayShapeLayer and EditShapeLayer render:
- The display layer shows the shape with selection styling (dotted border)
- The edit layer shows the shape being modified with draggable edit handles

Pass `selectedShapeId={editingShape?.id}` to the display layer to show selection styling during editing.

## Event Bus Integration

The layer emits events via `@accelint/bus` for the editing lifecycle:

### shapes:editing

Emitted when editing starts:

```tsx
import { useOn } from '@accelint/bus/react';
import { EditShapeEvents } from '@accelint/map-toolkit/deckgl/shapes';

useOn(EditShapeEvents.editing, (event) => {
  if (event.payload.mapId !== MAP_ID) return;
  console.log('Started editing:', event.payload.shape.name);
});
```

### shapes:updated

Emitted when a shape edit is saved:

```tsx
import { useOn } from '@accelint/bus/react';
import { EditShapeEvents, type ShapeUpdatedEvent } from '@accelint/map-toolkit/deckgl/shapes';

useOn<ShapeUpdatedEvent>(EditShapeEvents.updated, (event) => {
  if (event.payload.mapId !== MAP_ID) return;
  console.log('Shape updated:', event.payload.shape);
});
```

### shapes:edit-canceled

Emitted when editing is canceled (ESC key or programmatic cancel):

```tsx
import { useOn } from '@accelint/bus/react';
import { EditShapeEvents } from '@accelint/map-toolkit/deckgl/shapes';

useOn(EditShapeEvents.canceled, (event) => {
  if (event.payload.mapId !== MAP_ID) return;
  console.log('Edit canceled for:', event.payload.shape.name);
});
```

## Map Mode Integration

EditShapeLayer uses a **protected mode** pattern. When editing starts:

1. The layer requests a mode change to `'edit-shape'`
2. The layer registers as a "protector" of this mode
3. Other components cannot change the map mode while editing is active
4. When editing completes or is canceled, protection is released

This prevents accidental mode changes (e.g., from clicking UI elements) from interrupting an editing operation.

## Cursor Integration

When editing is active, the cursor automatically changes based on the edit mode:

| Edit Mode | Cursor |
|-----------|--------|
| `modify` | `crosshair` |
| `resize-circle` | `ew-resize` |
| `view` | `default` |

This integrates with the `map-cursor` system:

```tsx
// Required: subscribe to cursor store to enable cursor changes
const { cursor } = useMapCursor(MAP_ID);

// The cursor will change based on edit mode
console.log('Current cursor:', cursor);
```

## API Reference

### EditShapeLayerProps

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `id` | `string` | `'edit-shape-layer'` | Unique layer ID |
| `mapId` | `UniqueId` | Context ID | Map instance ID for multi-map isolation |
| `unit` | `DistanceUnitAbbreviation` | `'km'` | Distance unit for tooltip measurements during circle resize |

### useEditShape Hook

```tsx
import { useEditShape } from '@accelint/map-toolkit/deckgl/shapes';

const {
  edit,
  save,
  cancel,
  isEditing,
  editingShape,
  editingState,
} = useEditShape(mapId, options);
```

#### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `mapId` | `UniqueId` | Optional map instance ID. Uses context if not provided. |
| `options` | `UseEditShapeOptions` | Optional callbacks |

#### Options

| Option | Type | Description |
|--------|------|-------------|
| `onUpdate` | `(shape: DisplayShape) => void` | Called when shape edit is saved |
| `onCancel` | `(shape: DisplayShape) => void` | Called when editing is canceled |

#### Return Values

| Value | Type | Description |
|-------|------|-------------|
| `edit` | `(shape: DisplayShape, options?: EditShapeOptions) => void` | Start editing a shape |
| `save` | `() => void` | Save current edits |
| `cancel` | `() => void` | Cancel editing and restore original |
| `isEditing` | `boolean` | Whether currently editing |
| `editingShape` | `DisplayShape \| null` | Shape currently being edited |
| `editingState` | `EditingState \| null` | Full editing state object |

### EditShapeOptions

Options passed to the `edit()` function:

| Option | Type | Description |
|--------|------|-------------|
| `mode` | `'modify' \| 'resize-circle'` | Override the automatic mode selection |

### EditShapeEvents

Event constants for bus subscriptions:

| Event | Value | Description |
|-------|-------|-------------|
| `editing` | `'shapes:editing'` | Editing has started |
| `updated` | `'shapes:updated'` | Shape edit was saved |
| `canceled` | `'shapes:edit-canceled'` | Editing was canceled |

## Styling

During editing, the layer uses the shape's existing style properties with adjustments for edit mode:

| Property | Source | Notes |
|----------|--------|-------|
| Fill Color | `shape.feature.properties.styleProperties.fillColor` | Rendered at 20% opacity for translucent appearance |
| Stroke Color | `shape.feature.properties.styleProperties.strokeColor` | Full opacity |

Edit handles (vertices) are displayed as:
- White filled circles
- White outline for visibility against various backgrounds

## Examples

See the Storybook stories for interactive examples:

- **BasicEditing**: Edit polygon, rectangle, and line shapes
- **CircleEditing**: Edit circle shapes with resize mode
- **CombinedDrawAndEdit**: Drawing new shapes and editing existing ones
