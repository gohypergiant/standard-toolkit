import { Canvas, Meta } from '@storybook/addon-docs/blocks';

import * as KanbanStories from './kanban.stories';

<Meta of={KanbanStories} />

# Kanban

The Kanban component provides a flexible, drag-and-drop board for organizing tasks and workflows. It's ideal for project management, task tracking, agile workflows, and any scenario where you need to visualize items moving through different states or columns.

Built on top of [@dnd-kit](https://docs.dndkit.com/), the Kanban component provides smooth drag-and-drop interactions for both cards and columns, with visual feedback and position indicators.

It is composed of the following components:

- **Kanban** – Root container that wraps the entire kanban board
- **KanbanHeader** – Optional header for the board containing title, search, and actions
- **KanbanHeaderTitle** – Heading element for the board title
- **KanbanHeaderActions** – Container for header action buttons
- **KanbanHeaderSearch** – Search field for filtering cards
- **KanbanColumnContainer** – Container that holds all columns
- **KanbanColumn** – Individual column that contains cards
- **KanbanColumnHeader** – Header section of a column
- **KanbanColumnHeaderTitle** – Title of the column
- **KanbanColumnHeaderActions** – Container for column actions (includes card count)
- **KanbanColumnHeaderDragHandle** – Visual indicator for column dragging
- **KanbanColumnContent** – Container for cards within a column
- **KanbanColumnActions** – Action button for adding new cards
- **KanbanCard** – Individual draggable card component
- **KanbanCardHeader** – Header section of a card
- **KanbanCardHeaderTitle** – Title of the card
- **KanbanCardHeaderActions** – Container for card action buttons
- **KanbanCardBody** – Main content area of the card

## Getting Started

### Required: KanbanProvider

The Kanban component requires the `KanbanProvider` context to manage state, handle drag-and-drop operations, and coordinate card movements between columns.

```tsx
import { KanbanProvider } from '@accelint/design-toolkit';

function MyKanbanBoard() {
  const [columns, setColumns] = useState(initialColumns);

  return (
    <KanbanProvider columns={columns} updateColumnState={setColumns}>
      {/* Your Kanban components here */}
    </KanbanProvider>
  );
}
```

### Data Structure

The Kanban component expects data in the following format:

```tsx
type KanbanColumnData = {
  id: string;           // Unique identifier for the column
  title: string;        // Column display name
  cards: KanbanCardData[];
  canDrop?: boolean;    // Optional: whether cards can be dropped in this column
};

type KanbanCardData = {
  id: string;          // Unique identifier for the card
  title: string;       // Card display title
  body: ReactNode | string;  // Card content
  columnId: string;    // ID of the column this card belongs to
  position: number;    // Position within the column (0-indexed)
  isActive?: boolean;  // Optional: whether card is currently active
};
```

## Example Usage

### Basic Kanban Board

```tsx
import { useState } from 'react';
import { Kanban, KanbanProvider } from '@accelint/design-toolkit';

const initialColumns = [
  {
    id: 'todo',
    title: 'To Do',
    cards: [
      {
        id: 'card-1',
        title: 'Task 1',
        body: 'Description of task 1',
        columnId: 'todo',
        position: 0,
      },
    ],
  },
  {
    id: 'in-progress',
    title: 'In Progress',
    cards: [],
  },
  {
    id: 'done',
    title: 'Done',
    cards: [],
  },
];

function MyKanbanBoard() {
  const [columns, setColumns] = useState(initialColumns);

  return (
    <KanbanProvider columns={columns} updateColumnState={setColumns}>
      <Kanban>
        <KanbanHeader>
          <KanbanHeaderTitle>Project Board</KanbanHeaderTitle>
        </KanbanHeader>

        <KanbanColumnContainer>
          {columns.map((column) => (
            <KanbanColumn key={column.id} column={column}>
              <KanbanColumnHeader>
                <KanbanColumnHeaderDragHandle />
                <KanbanColumnHeaderTitle>
                  {column.title}
                </KanbanColumnHeaderTitle>
                <KanbanColumnHeaderActions cardCount={column.cards.length} />
              </KanbanColumnHeader>

              <KanbanColumnContent>
                {column.cards.map((card) => (
                  <KanbanCard key={card.id} card={card}>
                    <KanbanCardHeader>
                      <KanbanCardHeaderTitle>{card.title}</KanbanCardHeaderTitle>
                    </KanbanCardHeader>
                    <KanbanCardBody>{card.body}</KanbanCardBody>
                  </KanbanCard>
                ))}
                <KanbanColumnActions
                  onAddCard={() => {/* Handle add card */}}
                />
              </KanbanColumnContent>
            </KanbanColumn>
          ))}
        </KanbanColumnContainer>
      </Kanban>
    </KanbanProvider>
  );
}
```

<Canvas of={KanbanStories.Default} />

### With Search and Actions

```tsx
<KanbanProvider columns={columns} updateColumnState={setColumns}>
  <Kanban>
    <KanbanHeader>
      <KanbanHeaderTitle>My Project</KanbanHeaderTitle>
      <KanbanHeaderActions>
        <KanbanHeaderSearch
          onInput={(e) => handleSearch(e.currentTarget.value)}
          placeholder="Search cards..."
        />
        <Button onPress={handleAddColumn}>Add Column</Button>
      </KanbanHeaderActions>
    </KanbanHeader>

    <KanbanColumnContainer>
      {/* Columns here */}
    </KanbanColumnContainer>
  </Kanban>
</KanbanProvider>
```

<Canvas of={KanbanStories.CompleteExample} />

### Custom Card Content

Cards can contain any React content in the body:

```tsx
<KanbanCard card={card}>
  <KanbanCardHeader>
    <KanbanCardHeaderTitle>{card.title}</KanbanCardHeaderTitle>
    <KanbanCardHeaderActions>
      <Menu.Trigger>
        <Button variant="ghost" size="small">
          <Icon><MoreVert /></Icon>
        </Button>
        <Menu>
          <Menu.Item>Edit</Menu.Item>
          <Menu.Item>Delete</Menu.Item>
        </Menu>
      </Menu.Trigger>
    </KanbanCardHeaderActions>
  </KanbanCardHeader>

  <KanbanCardBody>
    <div className="space-y-2">
      <p>{card.description}</p>
      <div className="flex gap-2">
        <Badge>{card.priority}</Badge>
        <Badge>{card.assignee}</Badge>
      </div>
    </div>
  </KanbanCardBody>
</KanbanCard>
```

<Canvas of={KanbanStories.CompleteExample} />

## Drag and Drop Behavior

### Card Dragging
- Cards can be dragged within the same column to reorder
- Cards can be dragged between columns to move them to different states
- Visual indicators show where the card will be dropped
- A preview of the card follows the cursor during dragging

### Column Dragging
- Columns can be reordered by dragging the drag handle
- The entire column moves, including all its cards
- Visual feedback indicates valid drop positions

### Position Indicators
- **Top indicator**: Shown when hovering over the top half of a card
- **Bottom indicator**: Shown when hovering over the bottom half of a card
- Indicators provide clear visual feedback about drop position

## State Management

The `KanbanProvider` manages all drag-and-drop state through the `moveCard` function:

```tsx
const moveCard = (
  cardId: string,
  targetColumnId: string,
  targetPosition: number,
  closestEdge?: 'top' | 'bottom'
) => {
  // Automatically updates card positions
  // Handles moving between columns
  // Updates the columns state
};
```

You don't need to implement this yourself—the provider handles it automatically. Just provide the columns state and update function.

## Adding Cards

Use the `KanbanColumnActions` component to add new cards:

```tsx
const handleAddCard = (columnId: string) => {
  const newCard = {
    id: uuid(),
    title: 'New Card',
    body: 'Card description',
    columnId,
    position: columns.find(c => c.id === columnId).cards.length,
  };

  setColumns(columns.map(col =>
    col.id === columnId
      ? { ...col, cards: [...col.cards, newCard] }
      : col
  ));
};

<KanbanColumnActions onAddCard={() => handleAddCard(column.id)} />
```

<Canvas of={KanbanStories.CompleteExample} />

## Props

### KanbanProvider

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `columns` | `KanbanColumnData[]` | - | Array of column data |
| `updateColumnState` | `(columns: KanbanColumnData[]) => void` | - | Callback to update columns state |
| `children` | `ReactNode` | - | Provider children |

### Kanban

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Board content |
| `className` | `string` | - | Additional CSS classes |

### KanbanHeader

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Header content |
| `className` | `string` | - | Additional CSS classes |

### KanbanHeaderTitle

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Title text |
| `className` | `string` | - | Additional CSS classes |

### KanbanHeaderActions

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Action buttons and search |
| `className` | `string` | - | Additional CSS classes |

### KanbanHeaderSearch

Extends SearchField props.

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `classNames` | `{ field?, input?, clear?, loading?, search? }` | - | Custom class names |
| `onInput` | `(e: FormEvent<HTMLInputElement>) => void` | - | Search input handler |
| `variant` | `'filled' \| 'outline'` | `'outline'` | Visual variant |
| `isLoading` | `boolean` | `false` | Shows loading spinner |

### KanbanColumnContainer

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Column components |
| `className` | `string` | - | Additional CSS classes |

### KanbanColumn

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `column` | `KanbanColumnData` | - | Column data object |
| `children` | `ReactNode` | - | Column content |
| `className` | `string` | - | Additional CSS classes |

### KanbanColumnHeader

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Title, actions, drag handle |
| `className` | `string` | - | Additional CSS classes |

### KanbanColumnHeaderTitle

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Title text |
| `className` | `string` | - | Additional CSS classes |

### KanbanColumnHeaderActions

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `cardCount` | `number` | - | Displays count badge |
| `children` | `ReactNode` | - | Action buttons |
| `className` | `string` | - | Additional CSS classes |

### KanbanColumnHeaderDragHandle

No configurable props. Renders a drag icon for reordering columns.

### KanbanColumnContent

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `column` | `KanbanColumnData` | - | Column data for cards |
| `children` | `ReactNode` | - | Card components |
| `className` | `string` | - | Additional CSS classes |

### KanbanColumnActions

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `onAddCard` | `() => void` | - | Add card callback |
| `children` | `ReactNode` | - | Additional content |
| `className` | `string` | - | Additional CSS classes |

### KanbanCard

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `card` | `KanbanCardData` | - | Card data object |
| `isActive` | `boolean` | `false` | Whether currently dragging |
| `children` | `ReactNode` | - | Card content |
| `className` | `string` | - | Additional CSS classes |

### KanbanCardHeader

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Title and actions |
| `className` | `string` | - | Additional CSS classes |

### KanbanCardHeaderTitle

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Title text |
| `className` | `string` | - | Additional CSS classes |

### KanbanCardHeaderActions

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Action buttons |
| `className` | `string` | - | Additional CSS classes |

### KanbanCardBody

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `children` | `ReactNode` | - | Body content |
| `className` | `string` | - | Additional CSS classes |

## Accessibility

- Semantic HTML structure with proper headings
- ARIA labels for drag-and-drop operations
- Keyboard navigation support
- Screen reader announcements for state changes
- Focus management during drag operations

## Related

- [dnd-kit](https://docs.dndkit.com/)
- [GitHub Source](https://github.com/gohypergiant/standard-toolkit/tree/main/packages/design-toolkit/src/components/kanban)
